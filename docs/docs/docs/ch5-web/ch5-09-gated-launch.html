
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>5.9 Grayscale Publishing and A/B test · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="ch5-10-ext.html" />
    
    
    <link rel="prev" href="ch5-08-interface-and-web.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Giới thiệu
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../ch1-basic/">
            
                <a href="../ch1-basic/">
            
                    
                    Chương 1: Nền tảng ngôn ngữ Go
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../ch1-basic/ch1-01-genesis.html">
            
                <a href="../ch1-basic/ch1-01-genesis.html">
            
                    
                    1.1 Nguồn gốc của ngôn ngữ Go
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../ch1-basic/ch1-02-hello-revolution.html">
            
                <a href="../ch1-basic/ch1-02-hello-revolution.html">
            
                    
                    1.2 Sự tiến hóa của chương trình "Hello World"
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../ch1-basic/ch1-03-array-string-and-slice.html">
            
                <a href="../ch1-basic/ch1-03-array-string-and-slice.html">
            
                    
                    1.3 Array, strings và slices
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../ch1-basic/ch1-04-func-method-interface.html">
            
                <a href="../ch1-basic/ch1-04-func-method-interface.html">
            
                    
                    1.4 Functions, Methods và Interfaces
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="../ch1-basic/ch1-05-mem.html">
            
                <a href="../ch1-basic/ch1-05-mem.html">
            
                    
                    1.5 Điều khiển tuần tự cấu trúc vùng nhớ
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6" data-path="../ch1-basic/ch1-06-common-concurrency-mode.html">
            
                <a href="../ch1-basic/ch1-06-common-concurrency-mode.html">
            
                    
                    1.6 Các chế độ đồng thời thông dụng
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.7" data-path="../ch1-basic/ch1-07-error-and-panic.html">
            
                <a href="../ch1-basic/ch1-07-error-and-panic.html">
            
                    
                    1.7 Error và Exceptions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8" data-path="../ch1-basic/ch1-08-supplementary-notes.html">
            
                <a href="../ch1-basic/ch1-08-supplementary-notes.html">
            
                    
                    1.8 Ghi chú bổ sung
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../ch2-cgo/">
            
                <a href="../ch2-cgo/">
            
                    
                    Chương 2: lập trình CGO
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../ch2-cgo/ch2-01-quick-start.html">
            
                <a href="../ch2-cgo/ch2-01-quick-start.html">
            
                    
                    2.1 Quick Start
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../ch2-cgo/ch2-02-CGO-foundation.html">
            
                <a href="../ch2-cgo/ch2-02-CGO-foundation.html">
            
                    
                    2.2 CGO Foundation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../ch2-cgo/ch2-03-type-conversion.html">
            
                <a href="../ch2-cgo/ch2-03-type-conversion.html">
            
                    
                    2.3 Chuyển đổi kiểu
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../ch2-cgo/ch2-04-function-call.html">
            
                <a href="../ch2-cgo/ch2-04-function-call.html">
            
                    
                    2.4 Lời gọi hàm
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="../ch2-cgo/ch2-05-internal-mechanisms.html">
            
                <a href="../ch2-cgo/ch2-05-internal-mechanisms.html">
            
                    
                    2.5 Cơ chế bên trong CGO
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="../ch2-cgo/ch2-09-static-shared-lib.html">
            
                <a href="../ch2-cgo/ch2-09-static-shared-lib.html">
            
                    
                    2.9 Thư viện tĩnh và động
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.7" data-path="../ch2-cgo/ch2-10-link.html">
            
                <a href="../ch2-cgo/ch2-10-link.html">
            
                    
                    2.10  Biên dịch và liên kết các tham số
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.8" data-path="../ch2-cgo/ch2-11-ext.html">
            
                <a href="../ch2-cgo/ch2-11-ext.html">
            
                    
                    2.11 Ghi chú bổ sung
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../ch3-best-practice/">
            
                <a href="../ch3-best-practice/">
            
                    
                    Chương 3: Go Best Practices
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../ch4-rpc/">
            
                <a href="../ch4-rpc/">
            
                    
                    Chương 4: RPC và Protobuf
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../ch4-rpc/ch4-01-rpc-intro.html">
            
                <a href="../ch4-rpc/ch4-01-rpc-intro.html">
            
                    
                    4.1 Bắt đầu với RPC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../ch4-rpc/ch4-02-pb-intro.html">
            
                <a href="../ch4-rpc/ch4-02-pb-intro.html">
            
                    
                    4.2 Protobuf
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="../ch4-rpc/ch4-03-fun-fpc.html">
            
                <a href="../ch4-rpc/ch4-03-fun-fpc.html">
            
                    
                    4.3 RPC trong Golang
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="../ch4-rpc/ch4-04-grpc.html">
            
                <a href="../ch4-rpc/ch4-04-grpc.html">
            
                    
                    4.4 Bắt đầu với gRPC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="../ch4-rpc/ch4-05-grpc-advanced.html">
            
                <a href="../ch4-rpc/ch4-05-grpc-advanced.html">
            
                    
                    4.5 gRPC Nâng cao
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.6" data-path="../ch4-rpc/ch4-06-grpc-ext.html">
            
                <a href="../ch4-rpc/ch4-06-grpc-ext.html">
            
                    
                    4.6 gRPC và Protobuf extensions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.7" data-path="../ch4-rpc/ch4-07-pbgo.html">
            
                <a href="../ch4-rpc/ch4-07-pbgo.html">
            
                    
                    4.7 pbgo : Protobuf-based framework
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.8" data-path="../ch4-rpc/ch4-08-grpc-curl.html">
            
                <a href="../ch4-rpc/ch4-08-grpc-curl.html">
            
                    
                    4.8 grpcurl tool
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.9" data-path="../ch4-rpc/ch4-09-supplementary-notes.html">
            
                <a href="../ch4-rpc/ch4-09-supplementary-notes.html">
            
                    
                    4.9 Ghi chú bổ sung
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="./">
            
                <a href="./">
            
                    
                    Chương 5: Go và Web
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="ch5-01-introduction.html">
            
                <a href="ch5-01-introduction.html">
            
                    
                    5.1 Giới thiệu về Web Development
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="ch5-02-router.html">
            
                <a href="ch5-02-router.html">
            
                    
                    5.2 Routing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="ch5-03-middleware.html">
            
                <a href="ch5-03-middleware.html">
            
                    
                    5.3 Middleware
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="ch5-04-request-verification.html">
            
                <a href="ch5-04-request-verification.html">
            
                    
                    5.4 Kiểm tra yêu cầu validator
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5" data-path="ch5-05-database.html">
            
                <a href="ch5-05-database.html">
            
                    
                    5.5 Database và giao tiếp với Database
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6" data-path="ch5-06-service-flow-limitation.html">
            
                <a href="ch5-06-service-flow-limitation.html">
            
                    
                    5.6 Ratelimit Service Flow Limit
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.7" data-path="ch5-07-layout-of-web-project.html">
            
                <a href="ch5-07-layout-of-web-project.html">
            
                    
                    5.7 Bố cục thông thường của các dự án web lớn
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.8" data-path="ch5-08-interface-and-web.html">
            
                <a href="ch5-08-interface-and-web.html">
            
                    
                    5.8 Interface và Table Driven Development
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.6.9" data-path="ch5-09-gated-launch.html">
            
                <a href="ch5-09-gated-launch.html">
            
                    
                    5.9 Grayscale Publishing and A/B test
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.10" data-path="ch5-10-ext.html">
            
                <a href="ch5-10-ext.html">
            
                    
                    5.10 Ghi chú bổ sung
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../ch6-cloud/">
            
                <a href="../ch6-cloud/">
            
                    
                    Chương 6: Hệ thống phân tán
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="../ch6-cloud/ch6-01-dist-id.html">
            
                <a href="../ch6-cloud/ch6-01-dist-id.html">
            
                    
                    6.1 Distributed id generator
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="../ch6-cloud/ch6-02-lock.html">
            
                <a href="../ch6-cloud/ch6-02-lock.html">
            
                    
                    6.2 Distributed lock
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="../ch6-cloud/ch6-03-delay-job.html">
            
                <a href="../ch6-cloud/ch6-03-delay-job.html">
            
                    
                    6.3 Hệ thống tác vụ có trì hoãn
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="../ch6-cloud/Ch6-04-search-engine.html">
            
                <a href="../ch6-cloud/Ch6-04-search-engine.html">
            
                    
                    6.4 Công cụ tìm kiếm phân tán
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.5" data-path="../ch6-cloud/ch6-05-load-balance.html">
            
                <a href="../ch6-cloud/ch6-05-load-balance.html">
            
                    
                    6.5 Cân bằng tải
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.6" data-path="../ch6-cloud/ch6-06-config.html">
            
                <a href="../ch6-cloud/ch6-06-config.html">
            
                    
                    6.6 Quản lý cấu hình trong hệ thống phân tán
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.7" data-path="../ch6-cloud/ch6-07-crawler.html">
            
                <a href="../ch6-cloud/ch6-07-crawler.html">
            
                    
                    6.7 Trình thu thập thông tin phân tán
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.8" data-path="../ch6-cloud/ch6-08-ext.html">
            
                <a href="../ch6-cloud/ch6-08-ext.html">
            
                    
                    6.8 Phần mở rộng
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >5.9 Grayscale Publishing and A/B test</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="59-grayscale-publishing-and-ab-test">5.9 Grayscale Publishing and A/B test</h1>
<p>Nh&#x1EEF;ng c&#xF4;ng ty c&#xF3; t&#x1EA7;m c&#x1EE1; trung b&#xEC;nh th&#x1B0;&#x1EDD;ng cung c&#x1EA5;p d&#x1ECB;ch v&#x1EE5; cho h&#xE0;ng tri&#x1EC7;u users, trong khi h&#x1EC7; th&#x1ED1;ng c&#x1EE7;a c&#xE1;c c&#xF4;ng ty l&#x1EDB;n s&#x1EBD; ph&#x1EA3;i ph&#x1EE5;c v&#x1EE5; cho ch&#x1EE5;c tri&#x1EC7;u, th&#x1EAD;m ch&#xED; h&#xE0;ng t&#x1EC9; users. &#x110;&#x1EA7;u v&#xE0;o c&#x1EE7;a nh&#x1EEF;ng requests t&#x1EEB; c&#xE1;c h&#x1EC7; th&#x1ED1;ng l&#x1EDB;n th&#x1B0;&#x1EDD;ng b&#x1EA5;t t&#x1EAD;n, v&#xE0; b&#x1EA5;t c&#x1EE9; thay &#x111;&#x1ED5;i n&#xE0;o c&#x169;ng s&#x1EBD; &#x111;&#x1B0;&#x1EE3;c c&#x1EA3;m nh&#x1EAD;n t&#x1EEB; ng&#x1B0;&#x1EDD;i d&#xF9;ng cu&#x1ED1;i. V&#xED; d&#x1EE5;, n&#x1EBF;u h&#x1EC7; th&#x1ED1;ng c&#x1EE7;a b&#x1EA1;n t&#x1EEB; ch&#x1ED1;i m&#x1ED9;t s&#x1ED1; upstream requests tr&#xEA;n &#x111;&#x1B0;&#x1EDD;ng x&#x1EED; l&#xFD;, nguy&#xEA;n nh&#xE2;n &#x111;&#x1EBF;n t&#x1EEB; h&#x1EC7; th&#x1ED1;ng c&#x1EE7;a b&#x1EA1;n v&#xE0; n&#xF3; kh&#xF4;ng c&#xF3; t&#xED;nh ch&#x1ECB;u l&#x1ED7;i, sau &#x111;&#xF3; l&#x1ED7;i s&#x1EBD; &#x111;&#x1B0;&#x1EE3;c n&#xE9;m ra &#x111;&#x1EBF;n ng&#x1B0;&#x1EDD;i d&#xF9;ng cu&#x1ED1;i. T&#x1EA1;o th&#xE0;nh m&#x1ED9;t thi&#x1EC7;t h&#x1EA1;i th&#x1EF1;c s&#x1EF1; &#x111;&#x1EBF;n user, lo&#x1EA1;i c&#x1EE7;a thi&#x1EC7;t h&#x1EA1;i n&#xE0;y s&#x1EBD; hi&#x1EC3;n th&#x1ECB; m&#x1ED9;t pops up ch&#x1EE9;a nh&#x1EEF;ng th&#xF4;ng &#x111;i&#x1EC7;p l&#x1EA1; l&#x1EAB;m tr&#xEA;n l&#xE0;m m&#xE0;n h&#xEC;nh c&#x1EE7;a user app. Do users kh&#xF4;ng th&#x1EC3; bi&#x1EBF;t n&#xF3; l&#xE0; g&#xEC;, users c&#xF3; th&#x1EC3; qu&#xEA;n n&#xF3; &#x111;i, b&#x1EB1;ng vi&#x1EC7;c refreshing l&#x1EA1;i trang. Nh&#x1B0;ng n&#xF3; c&#x169;ng l&#xE0;m users m&#x1EA5;t &#x111;i c&#x1A1; h&#x1ED9;i mua m&#x1ED9;t m&#xF3;n h&#xE0;ng n&#xE0;o &#x111;&#xF3; v&#xEC; c&#xF3; h&#xE0;ng ch&#x1EE5;c ho&#x1EB7;c h&#xE0;ng ng&#xE0;n ng&#x1B0;&#x1EDD;i mua kh&#xE1;c c&#xF9;ng m&#x1ED9;t th&#x1EDD;i &#x111;i&#x1EC3;m, b&#x1EDF;i v&#xEC; nh&#x1EEF;ng v&#x1EA5;n &#x111;&#x1EC1; nh&#x1ECF; nh&#x1B0; v&#x1EAD;y trong m&#xE3; ngu&#x1ED3;n, l&#xE0;m m&#x1EA5;t &#x111;i l&#x1EE3;i th&#x1EBF; ban &#x111;&#x1EA7;u, v&#xE0; m&#x1EA5;t &#x111;i c&#x1A1; h&#x1ED9;i mua &#x111;&#x1B0;&#x1EE3;c m&#xF3;n h&#xE0;ng y&#xEA;u th&#xED;ch m&#xE0; h&#x1ECD; &#x111;&#xE3; ch&#x1EDD; &#x111;&#x1EE3;i trong v&#xE0;i th&#xE1;ng. M&#x1EE9;c &#x111;&#x1ED9; thi&#x1EC7;t h&#x1EA1;i m&#xE0; users ph&#x1EA3;i g&#xE1;nh ch&#x1ECB;u s&#x1EBD; ph&#x1EE5; thu&#x1ED9;c v&#xE0;o t&#x1EA7;m quan tr&#x1ECD;ng c&#x1EE7;a h&#x1EC7; th&#x1ED1;ng c&#x1EE7;a b&#x1EA1;n &#x111;&#x1ED1;i v&#x1EDB;i users.</p>
<p>Trong tr&#x1B0;&#x1EDD;ng h&#x1EE3;p n&#xE0;y, t&#xED;nh ch&#x1EA5;t fault tolerance (t&#xED;nh ch&#x1ECB;u l&#x1ED7;i) c&#x1EF1;c k&#x1EF3; quan tr&#x1ECD;ng trong h&#x1EC7; th&#x1ED1;ng l&#x1EDB;n. M&#x1EB7;c d&#xF9; ng&#xE0;y nay, nh&#x1EEF;ng c&#xF4;ng ty l&#xE0;m v&#x1EC1; internet th&#x1B0;&#x1EDD;ng n&#xF3;i r&#x1EB1;ng h&#x1ECD; &#x111;&#xE3; ki&#x1EC3;m tra nghi&#xEA;m ng&#x1EB7;t v&#xE0; tri&#x1EC7;t &#x111;&#x1EC3; tr&#x1B0;&#x1EDB;c khi &#x111;&#x1B0;a v&#xE0;o khai th&#xE1;c, cho d&#xF9; h&#x1ECD; l&#xE0;m v&#x1EAD;y ch&#x103;ng n&#x1EEF;a, code bugs v&#x1EAB;n kh&#xF4;ng th&#x1EC3; tr&#xE1;nh kh&#x1ECF;i. Ngay c&#x1EA3; khi m&#xE3; ngu&#x1ED3;n kh&#xF4;ng c&#xF3; bugs, s&#x1EF1; giao ti&#x1EBF;p gi&#x1EEF;a c&#xE1;c services trong h&#x1EC7; th&#x1ED1;ng ph&#xE2;n t&#xE1;n c&#x169;ng c&#xF3; th&#x1EC3;  g&#xE2;y ra l&#x1ED7;i.</p>
<p>V&#xE0;o th&#x1EDD;i &#x111;i&#x1EC3;m n&#xE0;y, &quot;Grayscale release&quot; c&#x1EF1;c k&#xEC; quan tr&#x1ECD;ng. Grayscale release c&#x169;ng th&#x1B0;&#x1EDD;ng &#x111;&#x1B0;&#x1EE3;c &#x111;&#x1B0;&#x1EE3;c g&#x1ECD;i l&#xE0; &quot;Canary release&quot; (canary: chim ho&#xE0;ng y&#x1EBF;n). V&#xE0;o th&#x1EBF; k&#x1EC9; 17, nh&#x1EEF;ng ng&#x1B0;&#x1EDD;i c&#xF4;ng nh&#xE2;n h&#x1EA7;m m&#x1ECF; &#x1EDF; Anh &#x111;&#xE3; ph&#xE1;t hi&#x1EC7;n ra r&#x1EB1;ng chim ho&#xE0;ng y&#x1EBF;n r&#x1EA5;t nh&#x1EA1;y c&#x1EA3;m v&#x1EDB;i kh&#xED; gas. Khi kh&#xED; gas &#x111;&#x1EA1;t t&#x1EDB;i m&#x1ED9;t n&#x1ED3;ng &#x111;&#x1ED9; n&#xE0;o &#x111;&#xF3;, th&#xEC; chim ho&#xE0;ng y&#x1EBF;n s&#x1EBD; ch&#x1EBF;t, nh&#x1B0;ng &#x1EDF; n&#x1ED3;ng &#x111;&#x1ED9; gas l&#xE0;m cho chim ho&#xE0;ng y&#x1EBF;n ch&#x1EBF;t l&#x1EA1;i kh&#xF4;ng g&#xE2;y h&#x1EA1;i cho con ng&#x1B0;&#x1EDD;i, do &#x111;&#xF3; chim ho&#xE0;ng y&#x1EBF;n &#x111;&#x1B0;&#x1EE3;c d&#xF9;ng &#x111;&#x1EC3; l&#xE0;m c&#xF4;ng c&#x1EE5; ph&#xE1;t hi&#x1EC7;n kh&#xED; gas. Grayscale publishing c&#x1EE7;a m&#x1ED9;t h&#x1EC7; th&#x1ED1;ng internet th&#xF4;ng th&#x1B0;&#x1EDD;ng &#x111;&#x1EA1;t &#x111;&#x1B0;&#x1EE3;c th&#xF4;ng qua hai c&#xE1;ch:</p>
<ol>
<li>Hi&#x1EC7;n th&#x1EF1;c Grayscale publishing th&#xF4;ng qua batch deployment.</li>
<li>Grayscale publishing th&#xF4;ng qua business rules.</li>
</ol>
<p>Ph&#x1B0;&#x1A1;ng ph&#xE1;p &#x111;&#x1EA7;u ti&#xEA;n &#x111;&#x1B0;&#x1EE3;c s&#x1EED; d&#x1EE5;ng nhi&#x1EC1;u trong c&#xE1;c h&#xE0;m c&#x169; c&#x1EE7;a h&#x1EC7; th&#x1ED1;ng. Khi m&#xE0; m&#x1ED9;t h&#xE0;m m&#x1EDB;i &#x111;&#x1B0;&#x1EE3;c &#x111;&#x1B0;a v&#xE0;o ho&#x1EA1;t &#x111;&#x1ED9;ng, th&#xEC; ph&#x1B0;&#x1A1;ng ph&#xE1;p th&#x1EE9; hai s&#x1EBD; &#x111;&#x1B0;&#x1EE3;c d&#xF9;ng nhi&#x1EC1;u h&#x1A1;n. D&#x129; nhi&#xEA;n, khi g&#xE2;y ra m&#x1ED9;t s&#x1ED1; thay &#x111;&#x1ED5;i ch&#xED;nh &#x111;&#x1EBF;n nh&#x1EEF;ng h&#xE0;m c&#x169; m&#xE0; ch&#xFA;ng quan tr&#x1ECD;ng, th&#xEC; th&#xF4;ng th&#x1B0;&#x1EDD;ng s&#x1EBD; t&#x1ED1;t h&#x1A1;n n&#x1EBF;u publish ch&#xFA;ng theo business rules, b&#x1EDF;i v&#xEC; &#x111;&#x1ED9; r&#x1EE7;i ro khi m&#x1EDF; t&#x1EA5;t c&#x1EA3; c&#xE1;c h&#xE0;m cho ng&#x1B0;&#x1EDD;i d&#xF9;ng l&#xE0; kh&#xE1; l&#x1EDB;n.</p>
<h2 id="591-implementing-grayscale-publishing-through-batch-deployment">5.9.1 Implementing grayscale publishing through batch deployment</h2>
<p>N&#x1EBF;u service &#x111;&#x1B0;&#x1EE3;c deploy tr&#xEA;n 15 instanses (c&#xF3; th&#x1EC3; l&#xE0; physical machines ho&#x1EB7;c containers), ch&#xFA;ng ta chia 15 instances th&#xE0;nh nh&#xF3;m theo th&#x1EE9; t&#x1EF1; &#x111;&#x1ED9; &#x1B0;u ti&#xEA;n, s&#x1EBD; c&#xF3; 1-2-4-8 machines, m&#x1ED7;i th&#x1EDD;i &#x111;i&#x1EC3;m. Khi m&#x1EDF; r&#x1ED9;ng ra, s&#x1ED1; l&#x1B0;&#x1EE3;ng t&#x103;ng g&#x1EA5;p &#x111;&#xF4;i.</p>
<p><div align="center">
    <img src="../images/ch5-online-group.png">
    <br>
    <span align="center">
        <i>Group deployment</i>
    </span>
</div>
<br></p>
<p>T&#x1EA1;i sao l&#x1EA1;i g&#x1EA5;p &#x111;&#xF4;i? N&#xF3; s&#x1EBD; &#x111;&#x1EA3;m b&#x1EA3;o r&#x1EB1;ng ch&#xFA;ng ta kh&#xF4;ng chia nh&#x1ECF; group qu&#xE1; nhi&#x1EC1;u, kh&#xF4;ng quan tr&#x1ECD;ng bao nhi&#xEA;u machines m&#xE0; ch&#xFA;ng ta c&#xF3;. Cho v&#xED; d&#x1EE5;, 1024 machines, trong th&#x1EF1;c t&#x1EBF;, ch&#x1EC9; c&#x1EA7;n 1-2-4-8-16-32-64-128-256-512 l&#xE0; 10 l&#x1EA7;n deployment &#x111;&#x1EC3; to&#xE0;n b&#x1ED9; &#x111;&#x1B0;&#x1EE3;c deployed.</p>
<p>Theo c&#xE1;ch &#x111;&#xF3;, nh&#x1EEF;ng users &#x111;&#x1EA7;u ti&#xEA;n b&#x1ECB; &#x1EA3;nh h&#x1B0;&#x1EDF;ng b&#x1EDF;i s&#x1EF1; thay &#x111;&#x1ED5;i s&#x1EBD; chi&#x1EBF;m m&#x1ED9;t ph&#x1EA7;n nh&#x1ECF; trong t&#x1ED5;ng s&#x1ED1; users, nh&#x1B0; l&#xE0; service c&#x1EE7;a 1000 machines. N&#x1EBF;u kh&#xF4;ng c&#xF3; v&#x1EA5;n &#x111;&#x1EC1; n&#xE0;o sau khi ch&#xFA;ng ta deployed to&#xE0;n b&#x1ED9; v&#xE0; &#x111;i v&#xE0;o ho&#x1EA1;t &#x111;&#x1ED9;ng, n&#xF3; s&#x1EBD; ch&#x1EC9; &#x1EA3;nh h&#x1B0;&#x1EDF;ng t&#x1EDB;i 1/1000 users. N&#x1EBF;u 10 groups ho&#xE0;n to&#xE0;n &#x111;&#x1B0;&#x1EE3;c chia ra &#x111;&#x1EC1;u nhau, th&#xEC; s&#x1EBD; &#x1EA3;nh h&#x1B0;&#x1EDF;ng t&#x1EDB;i 1/10 users ngay l&#x1EB7;p t&#x1EE9;c, v&#xE0; 1/10 c&#x1EE7;a business problems, n&#xF3; s&#x1EBD; l&#xE0; m&#x1ED9;t tai h&#x1ECD;a kh&#xF4;ng th&#x1EC3; kh&#x1EAF;c ph&#x1EE5;c c&#x1EE7;a c&#xF4;ng ty.</p>
<p>Khi &#x111;i v&#xE0;o ho&#x1EA1;t &#x111;&#x1ED9;ng, c&#xE1;ch hi&#x1EC7;u qu&#x1EA3; nh&#x1EA5;t &#x111;&#x1EC3; quan s&#xE1;t l&#xE0; nh&#xEC;n v&#xE0;o <code>error log</code> c&#x1EE7;a ch&#x1B0;&#x1A1;ng tr&#xEC;nh. N&#x1EBF;u kh&#xF4;ng c&#xF3; nhi&#x1EC1;u l&#x1ED7;i logic, th&#xEC; ch&#xFA;ng ta s&#x1EBD; scroll nhanh error log khi xem. Nh&#x1EEF;ng errors c&#xF3; th&#x1EC3; &#x111;&#x1B0;&#x1EE3;c b&#xE1;o c&#xE1;o trong h&#x1EC7; th&#x1ED1;ng monitoring c&#x1EE7;a c&#xF4;ng ty nh&#x1B0; l&#xE0; <code>metrics</code>. Do &#x111;&#xF3;, trong su&#x1ED1;t qu&#xE1; tr&#xEC;nh &#x111;i v&#xE0;o ho&#x1EA1;t &#x111;&#x1ED9;ng, c&#xF3; th&#x1EC3; th&#x1EA5;y r&#x1EB1;ng b&#x1EA5;t c&#x1EE9; l&#x1ED7;i b&#x1EA5;t th&#x1B0;&#x1EDD;ng n&#xE0;o x&#x1EA3;y ra s&#x1EBD; &#x111;&#x1B0;&#x1EE3;c monitoring.</p>
<p>N&#x1EBF;u c&#xF3; m&#x1ED9;t tr&#x1B0;&#x1EDD;ng h&#x1EE3;p b&#x1EA5;t th&#x1B0;&#x1EDD;ng, vi&#x1EC7;c l&#xE0;m &#x111;&#x1EA7;u ti&#xEA;n l&#xE0; roll back.</p>
<h2 id="592-grayscale-publishing-through-business-rules">5.9.2 Grayscale publishing through business rules</h2>
<p>C&#xF3; nhi&#x1EC1;u chi&#x1EBF;n l&#x1B0;&#x1EE3;c Grayscale ph&#x1ED5; bi&#x1EBF;n. V&#xED; d&#x1EE5;, chi&#x1EBF;n l&#x1B0;&#x1EE3;c c&#x1EE7;a ch&#xFA;ng ta l&#xE0; publish trong h&#xE0;ng ng&#xE0;n points. Sau &#x111;&#xF3; ch&#xFA;ng ta c&#xF3; th&#x1EC3; d&#xF9;ng user id, mobile phone number, user device information, v,v &#x111;&#x1EC3; sinh ra m&#x1ED9;t gi&#xE1; tr&#x1ECB; hash.</p>
<pre><code class="lang-go"><span class="hljs-comment">// pass 3/1000</span>
<span class="hljs-keyword">func</span> passed() <span class="hljs-keyword">bool</span> {
    key := hashFunctions(userID) % <span class="hljs-number">1000</span>
    <span class="hljs-keyword">if</span> key &lt;= <span class="hljs-number">2</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
}
</code></pre>
<h2 id="5921-optional-rules">5.9.2.1 Optional rules</h2>
<p>M&#x1ED9;t s&#x1ED1; h&#x1EC7; th&#x1ED1;ng Grayscale publishing ph&#x1ED5; bi&#x1EBF;n s&#x1EBD; c&#xF3; m&#x1ED9;t s&#x1ED1; rules ch&#x1ECD;n t&#x1EEB;:</p>
<pre><code>1. Published by city
2. Publish by probability
3. Published by percentage
4. Publish by whitelist
5. Published by line of business
6. Publish by UA (APP, Web, PC)
7. Publish by distribution channel
</code></pre><p>Publishing b&#x1EDF;i whitelist th&#xEC; t&#x1B0;&#x1A1;ng &#x111;&#x1ED1;i &#x111;&#x1A1;n gi&#x1EA3;n. Khi t&#xED;nh n&#x103;ng &#x111;&#x1B0;a v&#xE0;o ho&#x1EA1;t &#x111;&#x1ED9;ng, ch&#xFA;ng ta hy v&#x1ECD;ng r&#x1EB1;ng ch&#x1EC9; nh&#x1EEF;ng ng&#x1B0;&#x1EDD;i nh&#xE2;n vi&#xEA;n l&#xE0; testers trong c&#xF4;ng ty c&#xF3; th&#x1EC3; truy c&#x1EAD;p c&#xE1;c t&#xED;nh n&#x103;ng &#x111;&#xF3;. H&#x1ECD; s&#x1EBD; tr&#x1EF1;c ti&#x1EBF;p cho c&#xE1;c accounts v&#xE0; mailboxs v&#xE0;o whitelist v&#xE0; t&#x1EEB; ch&#x1ED1;i truy c&#x1EAD;p &#x111;&#x1EBF;n c&#xE1;c accounts kh&#xE1;c.</p>
<p>Publishing theo x&#xE1;c su&#x1EA5;t &#x111;&#x1B0;&#x1EE3;c hi&#x1EC7;n th&#x1EF1;c b&#x1EDF;i m&#x1ED9;t function &#x111;&#x1A1;n gi&#x1EA3;n:</p>
<pre><code class="lang-go"><span class="hljs-keyword">func</span> isTrue() <span class="hljs-keyword">bool</span> {
    <span class="hljs-comment">//return true/false according to the rate provided by user</span>
}
</code></pre>
<p>C&#xF3; th&#x1EC3; th&#x1EA5;y k&#x1EBF;t qu&#x1EA3; tr&#x1EA3; v&#x1EC1; theo x&#xE1;c su&#x1EA5;t &#x111;&#x1B0;&#x1EE3;c ghi nh&#x1EAD;n b&#x1EDF;i users l&#xE0; <code>true</code> ho&#x1EB7;c <code>false</code>. D&#x129; nhi&#xEA;n x&#xE1;c su&#x1EA5;t c&#x1EE7;a <code>true</code> v&#xE0; <code>false</code> trong m&#xE3; ngu&#x1ED3;n tr&#xEA;n c&#xF3; th&#x1EC3; l&#xE0; <code>100% true</code> v&#xE0; <code>0% false</code> ho&#x1EB7;c <code>0% true</code> v&#xE0; <code>100% false</code>. Function n&#xE0;y kh&#xF4;ng y&#xEA;u c&#x1EA7;u b&#x1EA5;t c&#x1EE9; input n&#xE0;o.</p>
<p>Publishing theo ph&#x1EA7;n tr&#x103;m ngh&#x129;a l&#xE0; s&#x1EBD; hi&#x1EC7;n th&#x1EF1;c m&#x1ED9;t function nh&#x1B0; sau:</p>
<pre><code class="lang-go"><span class="hljs-keyword">func</span> isTrue(phone <span class="hljs-keyword">string</span>) <span class="hljs-keyword">bool</span> {
    <span class="hljs-keyword">if</span> hash of phone matches {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
}
</code></pre>
<p>Tr&#x1B0;&#x1EDD;ng h&#x1EE3;p n&#xE0;y c&#xF3; th&#x1EC3; tr&#x1EA3; v&#x1EC1; k&#x1EBF;t qu&#x1EA3; <code>true</code> ho&#x1EB7;c <code>false</code> theo t&#x1EF7; l&#x1EC7; ph&#x1EA7;n tr&#x103;m &#x111;&#x1B0;&#x1EE3;c &#x111;&#x1EB7;c t&#x1EA3; tr&#x1B0;&#x1EDB;c, v&#xE0; &#x1EDF; tr&#xEA;n l&#xE0; s&#x1EF1; kh&#xE1;c bi&#x1EC7;t &#x111;&#x1A1;n gi&#x1EA3;n theo x&#xE1;c su&#x1EA5;t m&#xE0; ch&#xFA;ng ta c&#x1EA7;n ng&#x1B0;&#x1EDD;i g&#x1ECD;i cung c&#x1EA5;p m&#x1ED9;t tham s&#x1ED1; input parameter. Ch&#xFA;ng ta s&#x1EED; d&#x1EE5;ng input parameter nh&#x1B0; l&#xE0; m&#x1ED9;t th&#xF4;ng s&#x1ED1; &#x111;&#x1EC3; t&#xED;nh to&#xE1;n gi&#xE1; tr&#x1ECB; hash, sau &#x111;&#xF3; tr&#x1EA3; v&#x1EC1; k&#x1EBF;t qu&#x1EA3; l&#xE0; m&#x1ED9;t model. &#x110;i&#x1EC1;u n&#xE0;y &#x111;&#x1EA3;m b&#x1EA3;o r&#x1EB1;ng user s&#x1EBD; tr&#x1EA3; v&#x1EC1; c&#xF9;ng m&#x1ED9;t k&#x1EBF;t qu&#x1EA3; qua nhi&#x1EC1;u l&#x1EA7;n g&#x1ECD;i, trong ng&#x1EEF; c&#x1EA3;nh sau, thu&#x1EAD;t to&#xE1;n s&#x1EBD; ph&#xE2;n &#x111;o&#x1EA1;n &#x111;&#x1B0;&#x1EE3;c k&#x1EBF;t qu&#x1EA3; mong &#x111;&#x1EE3;i</p>
<p><div align="center">
    <img src="../images/ch5-set-time-line.png">
    <br>
    <span align="center">
        <i>First set and then get immediately</i>
    </span>
</div>
<br></p>
<p>N&#x1EBF;u b&#x1EA1;n d&#xF9;ng chi&#x1EBF;n l&#x1B0;&#x1EE3;c random, b&#x1EA1;n s&#x1EBD; g&#x1EB7;p m&#x1ED9;t v&#x1EA5;n &#x111;&#x1EC1; nh&#x1B0; h&#xEC;nh 5-22</p>
<p><div align="center">
    <img src="../images/ch5-set-time-line_2.png">
    <br>
    <span align="center">
        <i>First set and then get immediately</i>
    </span>
</div>
<br></p>
<h2 id="593-l&#xE0;m-th&#x1EBF;-n&#xE0;o-&#x111;&#x1EC3;-hi&#x1EC7;n-th&#x1EF1;c-h&#x1EC7;-th&#x1ED1;ng-grayscale-publishing">5.9.3 L&#xE0;m th&#x1EBF; n&#xE0;o &#x111;&#x1EC3; hi&#x1EC7;n th&#x1EF1;c h&#x1EC7; th&#x1ED1;ng Grayscale publishing</h2>
<h3 id="5931-business-related-simple-grayscale">5.9.3.1 Business-related simple grayscale</h3>
<p>C&#xF4;ng ty th&#xF4;ng th&#x1B0;&#x1EDD;ng s&#x1EBD; c&#xF3; m&#x1ED9;t b&#x1EA3;ng &#xE1;nh x&#x1EA1; gi&#x1EEF;a t&#xEA;n c&#x1EE7;a th&#xE0;nh ph&#x1ED1; v&#xE0; <code>ids</code>. N&#x1EBF;u business ch&#x1EC9; trong v&#xF2;ng m&#x1ED9;t qu&#x1ED1;c gia, s&#x1ED1; th&#xE0;nh ph&#x1ED1; s&#x1EBD; kh&#xF4;ng th&#x1EF1;c s&#x1EF1; l&#x1EDB;n, v&#xE0; <code>ids</code> c&#xF3; th&#x1EC3; trong v&#xF2;ng <code>10,000</code>. Ch&#xFA;ng ta ch&#x1EC9; c&#x1EA7;n m&#x1ED9;t m&#x1EA3;ng <code>bool</code> c&#xF3; k&#xED;ch th&#x1B0;&#x1EDB;c kho&#x1EA3;ng <code>10,000</code> &#x111;&#x1EA1;t &#x111;&#x1B0;&#x1EE3;c nhu c&#x1EA7;u.</p>
<pre><code class="lang-go"><span class="hljs-keyword">var</span> cityID2Open = [<span class="hljs-number">12000</span>]<span class="hljs-keyword">bool</span>{}

<span class="hljs-keyword">func</span> init() {
    readConfig()
    <span class="hljs-keyword">for</span> i:=<span class="hljs-number">0</span>;i&lt;<span class="hljs-built_in">len</span>(cityID2Open);i++ {
        <span class="hljs-keyword">if</span> city i is opened in configs {
            cityID2Open[i] = <span class="hljs-literal">true</span>
        }
    }
}

<span class="hljs-keyword">func</span> isPassed(cityID <span class="hljs-keyword">int</span>) <span class="hljs-keyword">bool</span> {
    <span class="hljs-keyword">return</span> cityID2Open[cityID]
}
</code></pre>
<p>N&#x1EBF;u c&#xF4;ng ty s&#x1EED; d&#x1EE5;ng gi&#xE1; tr&#x1ECB; l&#x1EDB;n l&#x1A1;n cho cityID, th&#xEC; ch&#xFA;ng ta c&#xF3; th&#x1EC3; c&#xE2;n nh&#x1EAF;c s&#x1EED; d&#x1EE5;ng map &#x111;&#x1EC3; l&#x1B0;u tr&#x1EEF; gi&#xE1; tr&#x1ECB;. C&#xE2;u truy v&#x1EA5;n map s&#x1EBD; th&#x1B0;&#x1EDD;ng ch&#x1EAD;m h&#x1A1;n array, nh&#x1B0;ng vi&#x1EC7;c m&#x1EDF; r&#x1ED9;ng s&#x1EBD; linh ho&#x1EA1;t h&#x1A1;n</p>
<pre><code class="lang-go"><span class="hljs-keyword">var</span> cityID2Open = <span class="hljs-keyword">map</span>[<span class="hljs-keyword">int</span>]<span class="hljs-keyword">struct</span>{}{}

<span class="hljs-keyword">func</span> init() {
    readConfig()
    <span class="hljs-keyword">for</span> _, city := <span class="hljs-keyword">range</span> openCities {
        cityID2Open[city] = <span class="hljs-keyword">struct</span>{}{}
    }
}

<span class="hljs-keyword">func</span> isPassed(cityID <span class="hljs-keyword">int</span>) <span class="hljs-keyword">bool</span> {
    <span class="hljs-keyword">if</span> _, ok := cityID2Open[cityID]; ok {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
}
</code></pre>
<p>Publishing b&#x1EDF;i probability (x&#xE1;c su&#x1EA5;t) &#x111;&#x1EB7;c bi&#x1EC7;t h&#x1A1;n t&#xED;, nh&#x1B0;ng r&#x1EA5;t d&#x1EC5; &#x111;&#x1EC3; hi&#x1EC7;n th&#x1EF1;c m&#xE0; kh&#xF4;ng c&#x1EA7;n t&#x1EDB;i input.</p>
<pre><code class="lang-go"><span class="hljs-keyword">func</span> init() {
    rand.Seed(time.Now().UnixNano())
}

<span class="hljs-comment">// rate t&#x1EEB; 0 t&#x1EDB;i 100</span>
<span class="hljs-keyword">func</span> isPassed(rate <span class="hljs-keyword">int</span>) <span class="hljs-keyword">bool</span> {
    <span class="hljs-keyword">if</span> rate &gt;= <span class="hljs-number">100</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    }

    <span class="hljs-keyword">if</span> rate &gt; <span class="hljs-number">0</span> &amp;&amp; rand.Int(<span class="hljs-number">100</span>) &gt; rate {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
}
</code></pre>
<p>Ch&#xFA; &#xFD; t&#x1EDB;i kh&#x1EDF;i t&#x1EA1;o <code>seed</code>.</p>
<h3 id="5932-hash-algorithm">5.9.3.2 Hash algorithm</h3>
<p>C&#xF3; nhi&#x1EC1;u thu&#x1EAD;t tho&#xE1;n hash nh&#x1B0; l&#xE0; <code>md5</code>, <code>crc32</code>, <code>sha1</code>, v,v,.. nh&#x1B0;ng m&#x1EE5;c &#x111;&#xED;ch m&#xE0; ch&#xFA;ng ta h&#x1B0;&#x1EDB;ng &#x111;&#x1EBF;n l&#xE0; &#xE1;nh x&#x1EA1; nh&#x1EEF;ng data t&#x1EDB;i key t&#x1B0;&#x1A1;ng &#x1EE9;ng, v&#xE0; ta kh&#xF4;ng mu&#x1ED1;n s&#x1EED; d&#x1EE5;ng qu&#xE1; nhi&#x1EC1;u CPU cho vi&#x1EC7;c t&#xED;nh to&#xE1;n hash. &#x110;a s&#x1ED1; c&#xE1;c thu&#x1EAD;t to&#xE1;n &#x111;&#x1EC1;u <code>murmurhash</code>, sau &#x111;&#xE2;y l&#xE0; k&#x1EBF;t qu&#x1EA3; benchmark cho nh&#x1EEF;ng thu&#x1EAD;t to&#xE1;n hash ph&#x1ED5; bi&#x1EBF;n &#x111;&#xF3;.</p>
<p>Sau khi d&#xF9;ng th&#x1B0; vi&#x1EC7;n chu&#x1EA9;n <code>md5</code>, <code>sha1</code> v&#xE0; opensource hi&#x1EC7;n th&#x1EF1;c <code>murmur3</code> cho vi&#x1EC7;c so s&#xE1;nh</p>
<pre><code class="lang-go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">&quot;crypto/md5&quot;</span>
    <span class="hljs-string">&quot;crypto/sha1&quot;</span>

    <span class="hljs-string">&quot;github.com/spaolacci/murmur3&quot;</span>
)

<span class="hljs-keyword">var</span> str = <span class="hljs-string">&quot;hello world&quot;</span>

<span class="hljs-keyword">func</span> md5Hash() [<span class="hljs-number">16</span>]<span class="hljs-keyword">byte</span> {
    <span class="hljs-keyword">return</span> md5.Sum([]<span class="hljs-keyword">byte</span>(str))
}

<span class="hljs-keyword">func</span> sha1Hash() [<span class="hljs-number">20</span>]<span class="hljs-keyword">byte</span> {
    <span class="hljs-keyword">return</span> sha1.Sum([]<span class="hljs-keyword">byte</span>(str))
}

<span class="hljs-keyword">func</span> murmur32() <span class="hljs-keyword">uint32</span> {
    <span class="hljs-keyword">return</span> murmur3.Sum32([]<span class="hljs-keyword">byte</span>(str))
}

<span class="hljs-keyword">func</span> murmur64() <span class="hljs-keyword">uint64</span> {
    <span class="hljs-keyword">return</span> murmur3.Sum64([]<span class="hljs-keyword">byte</span>(str))
}
</code></pre>
<p>Vi&#x1EBF;t benchmark test cho c&#xE1;c thu&#x1EAD;t to&#xE1;n &#x111;&#xF3;:</p>
<pre><code class="lang-go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">&quot;testing&quot;</span>

<span class="hljs-keyword">func</span> BenchmarkMD5(b *testing.B) {
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; b.N; i++ {
        md5Hash()
    }
}

<span class="hljs-keyword">func</span> BenchmarkSHA1(b *testing.B) {
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; b.N; i++ {
        sha1Hash()
    }
}

<span class="hljs-keyword">func</span> BenchmarkMurmurHash32(b *testing.B) {
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; b.N; i++ {
        murmur32()
    }
}

<span class="hljs-keyword">func</span> BenchmarkMurmurHash64(b *testing.B) {
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; b.N; i++ {
        murmur64()
    }
}
</code></pre>
<p>Sau &#x111;&#xF3; xem k&#x1EBF;t qu&#x1EA3; ch&#x1EA1;y nh&#x1B0; sau:</p>
<pre><code class="lang-sh">$ go <span class="hljs-built_in">test</span> -bench=.
goos: darwin
goarch: amd64
BenchmarkMD5-4          10000000 180 ns/op
BenchmarkSHA1-4         10000000 211 ns/op
BenchmarkMurmurHash32-4 50000000  25.7 ns/op
BenchmarkMurmurHash64-4 20000000  66.2 ns/op
PASS
ok _/Users/caochunhui/<span class="hljs-built_in">test</span>/go/<span class="hljs-built_in">hash</span>_bench 7.050s
</code></pre>
<p>C&#xF3; th&#x1EC3; th&#x1EA5;y r&#x1EB1;ng <strong>murmurhash</strong> c&#xF3; hi&#x1EC7;u su&#x1EA5;t cao g&#x1EA5;p ba so v&#x1EDB;i c&#xE1;c h&#xE0;m thu&#x1EAD;t to&#xE1;n hash kh&#xE1;c. Hi&#x1EC3;n nhi&#xEA;n, &#x111;&#x1EC3; th&#x1EF1;c hi&#x1EC7;n vi&#x1EC7;c <code>load balancing</code> (c&#xE2;n b&#x1EB1;ng t&#x1EA3;i), murmurhash s&#x1EBD; t&#x1ED1;t h&#x1A1;n <code>md5</code> v&#xE0; <code>sha1</code>. Th&#x1EF1;c t&#x1EBF;, &#x111;&#xF3; l&#xE0; thu&#x1EAD;t to&#xE1;n hash hi&#x1EC7;u qu&#x1EA3; trong c&#x1ED9;ng &#x111;&#x1ED3;ng v&#xE0;i n&#x103;m v&#x1EEB;a qua, ng&#x1B0;&#x1EDD;i &#x111;&#x1ECD;c c&#xF3; th&#x1EC3; t&#x1EF1; nghi&#xEA;n c&#x1EE9;u.</p>
<h3 id="5933-li&#x1EC7;u-c&#xF3;-m&#x1ED9;t-m&#xF4;-h&#xEC;nh-ph&#xE2;n-ph&#x1ED1;i-chu&#x1EA9;n-kh&#xF4;ng-">5.9.3.3 Li&#x1EC7;u c&#xF3; m&#x1ED9;t m&#xF4; h&#xEC;nh ph&#xE2;n ph&#x1ED1;i chu&#x1EA9;n kh&#xF4;ng ?</h3>
<p>Cho m&#x1ED9;t thu&#x1EAD;t to&#xE1;n hash, xem x&#xE9;t v&#x1EA5;n &#x111;&#x1EC1; hi&#x1EC7;u su&#x1EA5;t, s&#x1EBD; th&#x1EF1;c s&#x1EF1; c&#x1EA7;n thi&#x1EBF;t khi xem x&#xE9;t khi n&#xE0;o gi&#xE1; tr&#x1ECB; hash s&#x1EBD; theo ph&#xE2;n ph&#x1ED1;i chu&#x1EA9;n. N&#x1EBF;u gi&#xE1; tr&#x1ECB; sau khi hash kh&#xF4;ng theo ph&#xE2;n ph&#x1ED1;i chu&#x1EA9;n, th&#xEC; s&#x1EBD; kh&#xF4;ng &#x111;&#x1EA1;t &#x111;&#x1B0;&#x1EE3;c hi&#x1EC7;u &#x1EE9;ng <code>uniform gray</code>.</p>
<p>X&#xE9;t <code>murmur3</code> l&#xE0; m&#x1ED9;t v&#xED; d&#x1EE5;, h&#xE3;y b&#x1EAF;t &#x111;&#x1EA7;u v&#x1EDB;i <code>15810000000</code>, sinh ra m&#x1B0;&#x1EDD;i tri&#x1EC7;u con s&#x1ED1; di &#x111;&#x1ED9;ng t&#x1B0;&#x1A1;ng t&#x1EF1; nhau, sau &#x111;&#xF3; t&#xED;nh to&#xE1;n gi&#xE1; tr&#x1ECB; hash v&#xE0; chia v&#xE0;o m&#x1B0;&#x1EDD;i <code>buckets</code> v&#xE0; quan s&#xE1;t khi n&#xE0;o gi&#xE1; tr&#x1ECB; &#x111;&#x1EC1;u nhau</p>
<pre><code class="lang-go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">&quot;fmt&quot;</span>

    <span class="hljs-string">&quot;github.com/spaolacci/murmur3&quot;</span>
)

<span class="hljs-keyword">var</span> bucketSize = <span class="hljs-number">10</span>

<span class="hljs-keyword">func</span> main() {
    <span class="hljs-keyword">var</span> bucketMap = <span class="hljs-keyword">map</span>[<span class="hljs-keyword">uint64</span>]<span class="hljs-keyword">int</span>{}
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">15000000000</span>; i &lt; <span class="hljs-number">15000000000</span>+<span class="hljs-number">10000000</span>; i++ {
        hashInt := murmur64(fmt.Sprint(i)) % <span class="hljs-keyword">uint64</span>(bucketSize)
        bucketMap[hashInt]++
    }
    fmt.Println(bucketMap)
}

<span class="hljs-keyword">func</span> murmur64(p <span class="hljs-keyword">string</span>) <span class="hljs-keyword">uint64</span> {
    <span class="hljs-keyword">return</span> murmur3.Sum64([]<span class="hljs-keyword">byte</span>(p))
}
</code></pre>
<p>H&#xE3;y xem k&#x1EBF;t qu&#x1EA3; th&#x1EF1;c thi</p>
<pre><code class="lang-go"><span class="hljs-keyword">map</span>[<span class="hljs-number">7</span>:<span class="hljs-number">999475</span> <span class="hljs-number">5</span>:<span class="hljs-number">1000359</span> <span class="hljs-number">1</span>:<span class="hljs-number">999945</span> <span class="hljs-number">6</span>:<span class="hljs-number">1000200</span> <span class="hljs-number">3</span>:<span class="hljs-number">1000193</span> <span class="hljs-number">9</span>:<span class="hljs-number">1000765</span> <span class="hljs-number">2</span>:<span class="hljs-number">1000044</span> \
<span class="hljs-number">4</span>:<span class="hljs-number">1000343</span> <span class="hljs-number">8</span>:<span class="hljs-number">1000823</span> <span class="hljs-number">0</span>:<span class="hljs-number">997853</span>]
</code></pre>
<p>&#x110;&#x1ED9; sai l&#x1EC7;ch trong v&#xF2;ng 1/100 v&#xE0; c&#xF3; th&#x1EC3; ch&#x1EA5;p nh&#x1EAD;n &#x111;&#x1B0;&#x1EE3;c. Khi &#x111;&#x1ED9;c gi&#x1EA3; &#x111;&#x1ED1;i chi&#x1EBF;u v&#x1EDB;i c&#xE1;c thu&#x1EAD;t to&#xE1;n kh&#xE1;c v&#xE0; &#x111;&#xE1;nh gi&#xE1; c&#xE1;i n&#xE0;o s&#x1EBD; &#x111;&#x1B0;&#x1EE3;c d&#xF9;ng cho Grayscale publishing, c&#xF3; th&#x1EC3; xem x&#xE9;t t&#x1EDB;i hi&#x1EC7;u su&#x1EA5;t v&#xE0; t&#xED;nh c&#xE2;n b&#x1EB1;ng trong ch&#x1B0;&#x1A1;ng n&#xE0;y.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="ch5-08-interface-and-web.html" class="navigation navigation-prev " aria-label="Previous page: 5.8 Interface và Table Driven Development">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="ch5-10-ext.html" class="navigation navigation-next " aria-label="Next page: 5.10 Ghi chú bổ sung">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"5.9 Grayscale Publishing and A/B test","level":"1.6.9","depth":2,"next":{"title":"5.10 Ghi chú bổ sung","level":"1.6.10","depth":2,"path":"ch5-web/ch5-10-ext.md","ref":"ch5-web/ch5-10-ext.md","articles":[]},"previous":{"title":"5.8 Interface và Table Driven Development","level":"1.6.8","depth":2,"path":"ch5-web/ch5-08-interface-and-web.md","ref":"ch5-web/ch5-08-interface-and-web.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"ch5-web/ch5-09-gated-launch.md","mtime":"2019-07-31T08:36:17.914Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2019-07-31T08:36:39.868Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

